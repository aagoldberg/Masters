---
title: "Grando-Project"
author: "John Grando"
date: "March 6, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=90),tidy=TRUE)
```

## Grando - Data Project Proposal

### Data Preparation

```{r}
#Set the working directory and read in the files
if (Sys.info()["sysname"]=="Windows"){
  setwd("~/Masters/DATA606/DataProject")
} else {
  setwd("~/Documents/Masters/DATA606/DataProject")
}
fileurl = "PublicLEEDProjectDirectory.csv"
project_data <- read.csv(file = fileurl, header = TRUE, sep = ",", stringsAsFactors = FALSE)
svfileurl = "SummaryVersionsMap.csv"
sv_data <- read.csv(file = svfileurl, header = TRUE, sep = ",", stringsAsFactors = FALSE)
#Format dates
project_data$CertDate <- as.Date(project_data$CertDate,"%m/%d/%Y")
project_data$RegistrationDate <- as.Date(project_data$RegistrationDate,"%m/%d/%Y")
#Add two calculated columns.  SubtmittalTime is the number of days between certification and registration dates (completed projects).  SubmittalTimePending is the number of days between the date the information was pulled and the registration date (open projects). 
project_data$SubmittalTime <- as.numeric(project_data$CertDate - project_data$RegistrationDate)
latest_date <- max(project_data$RegistrationDate, na.rm = TRUE)
project_data$SubmittalTimePending <- ifelse(is.na(project_data$CertDate)==TRUE,latest_date-project_data$RegistrationDate,NA)
#Run sapply() to do a table join between the project directory data and the SummaryVersionsMap file.  The latter file is a mapping scheme that provides further sub-category information to each project type.
project_data$RatingSystemFamily <- sapply(project_data$LEEDSystemVersionDisplayName, 
                                          function(x){
                                            x <- sv_data[which(sv_data$RatingSystem == x),2]
                                            x <- ifelse(identical(x, character(0)), character(0), as.character(x))
                                          }
                                          )
project_data$System <- sapply(project_data$LEEDSystemVersionDisplayName, 
                             function(x){
                               x <- sv_data[which(sv_data$RatingSystem == x),3]
                               x <- ifelse(identical(x, character(0)), character(0), as.character(x))
                             }
)
project_data$Version <- sapply(project_data$LEEDSystemVersionDisplayName, 
                              function(x){
                                x <- sv_data[which(sv_data$RatingSystem == x),4]
                                x <- ifelse(identical(x, character(0)), character(0), as.character(x))
                              }
)
project_data$Platform <- sapply(project_data$LEEDSystemVersionDisplayName, 
                              function(x){
                                x <- sv_data[which(sv_data$RatingSystem == x),5]
                                x <- ifelse(identical(x, character(0)), character(0), as.character(x))
                              }
)
project_data$RSLaunch <- sapply(project_data$LEEDSystemVersionDisplayName, 
                                function(x){
                                  x <- sv_data[which(sv_data$RatingSystem == x),6]
                                }
)
project_data$RSLaunch <- as.Date(as.character(project_data$RSLaunch),"%m/%d/%Y")
project_data$RSRegClose <- sapply(project_data$LEEDSystemVersionDisplayName, 
                                function(x){
                                  x <- sv_data[which(sv_data$RatingSystem == x),7]
                                }
)
project_data$RSRegClose <- as.Date(as.character(project_data$RSRegClose),"%m/%d/%Y")
project_data$RSSunset <- sapply(project_data$LEEDSystemVersionDisplayName, 
                                  function(x){
                                    x <- sv_data[which(sv_data$RatingSystem == x),8]
                                  }
)
project_data$RSSunset <- as.Date(as.character(project_data$RSSunset),"%m/%d/%Y")
project_data$RSIteration <- sapply(project_data$LEEDSystemVersionDisplayName, 
                                function(x){
                                  x <- sv_data[which(sv_data$RatingSystem == x),9]
                                }
)
project_data$RSIteration <- as.integer(as.character(project_data$RSIteration))

#Add a few more calculated columns now that the sub-category data has been added.
project_data$RegAfterLaunch <- as.integer(project_data$RegistrationDate - project_data$RSLaunch)
project_data$CertAfterLaunch <- as.integer(project_data$CertDate - project_data$RSLaunch)
project_data$RegYear <- trunc(project_data$RegAfterLaunch / 365) + 1
project_data$CertYear <- trunc(project_data$CertAfterLaunch / 365) + 1

#Create more generalized categories of the Owner types.
project_data$OwnerTypesAdj <- sapply(project_data$OwnerTypes, 
                                     function(x){
                                       x <- ifelse(grepl("government",tolower(x)),"government",
                                            ifelse(grepl("education",tolower(x)),"education",
                                            ifelse(grepl("confidential",tolower(x)),"confidential",
                                            ifelse(grepl("corporate",tolower(x)),"corporate",
                                            ifelse(grepl("^profit",tolower(x)),"profit",
                                            ifelse(grepl("^non-profit",tolower(x)),"non-profit",
                                            ifelse(grepl("individual",tolower(x)),"individual",
                                            ifelse(grepl("investor",tolower(x)),"investor",
                                            ifelse(x=="",NA,
                                            ifelse(is.null(x),NULL,
                                            "other"))))))))))
                                     }
)
#I am planning to do some comparions between v2 and v3 Platforms.  These are two versions of the LEED Rating system and represent a significant change in prerequisite and credit requirements.  One major issue is that because v2 came first, the projects have had a much longer opportunity to stay open than the v3 projects.  In an attempt to normalize this, I have taken a snapshot of the v2 data at the same point in time as v3.  Specifically, I found how many days the v3 Platform has been open and made a cutoff date that was the same number of days after the v2 launch.  Any v2 projects that were open on that cutoff date were considered still open and the SubmittalTimePending was calculated using the v2cutoff date - the registration date.

#Days the v3 platform has been open since launch
maxv3days <- as.numeric(latest_date- as.Date("4/27/2009","%m/%d/%Y"))

#Cutoff date for v2 which is maxv3days after the v2 launch
v2cutoff <- as.Date("11/15/2000","%m/%d/%Y") + maxv3days

#Create an adjusted timeline for v2 projects
project_data$TimeAdj <- ifelse(project_data$Platform=="v2",v2cutoff - project_data$RegistrationDate, NA)

#take subset of data that only includes v3 projects and v2 projects with positive values.  A negative TimeAdj would indicate the individual project was in the beta program and registered before the actual launch.
project_data_reduc <- subset(project_data, project_data$Platform=="v3" | (project_data$Platform=="v2" & project_data$TimeAdj>0))

#Create the adjusted SubmittalTime for v2 projects, just take the original SubmittalTime for v3 projects 
project_data_reduc$SubmittalTimeAdj <- ifelse(project_data_reduc$Platform=="v2" & project_data_reduc$CertDate < v2cutoff, 
                                              project_data_reduc$CertDate - project_data_reduc$RegistrationDate,
                                              ifelse(project_data_reduc$Platform=="v3",
                                                     project_data_reduc$SubmittalTime,
                                                     NA))
#Create the adjusted SubmittalTimePending for v2 projects, just take the original SubmittalTime for v3 projects 
project_data_reduc$SubmittalTimePendingAdj <- ifelse(project_data_reduc$Platform=="v2" & (is.na(project_data_reduc$CertDate)==TRUE | project_data_reduc$CertDate > v2cutoff),
                                                     v2cutoff-project_data_reduc$RegistrationDate,
                                                     project_data_reduc$SubmittalTimePending)
#Create a subset of completed projects that have relevant data.
completed_projects <- subset(project_data_reduc, project_data_reduc$RegAfterLaunch>0 & project_data_reduc$SubmittalTimeAdj>0 & !(is.na(project_data_reduc$CertDate)) & !(identical(project_data_reduc$RatingSystemFamily, character(0))) & !(is.na(project_data_reduc$RatingSystemFamily)) & !(project_data_reduc$RatingSystemFamily=="ND"))
#Create a subset for open projects.
open_projects <- subset(project_data_reduc, project_data_reduc$RegAfterLaunch>0 & project_data_reduc$SubmittalTimePendingAdj>0 & is.na(project_data_reduc$CertDate) & !(identical(project_data_reduc$RatingSystemFamily,character(0))) & !(is.na(project_data_reduc$Platform)) & !(project_data_reduc$RatingSystemFamily=="ND"))

```

### Research question 

**You should phrase your research question in a way that matches up with the scope of inference your dataset allows for.**

Is there a significant difference between the number of days it takes for a project to certify (from the time it was regiestered) between owner types, rating system families, and/or platform versions?   

### Cases 

**What are the cases, and how many are there?**

Each case represents a registered LEED project.  There are `r nrow(project_data)` observations in the given data set.

### Data collection 

**Describe the method of data collection.**

Upon registering a LEED project, the information in this data set is populated as a part of the requirments of the LEED process.

### Type of study 

**What type of study is this (observational/experiment)?**

This is an observational study.

### Data Source 

**If you collected the data, state self-collected. If not, provide a citation/link.**

The project data is collected by the United States Green Building Council and is available online here: http://www.usgbc.org/project-download-all.  The version mapping table is not publicly available in a single format. however, all the infomration needed to create this data set is available on http://www.usgbc.org.

### Response 

**What is the response variable, and what type is it (numerical/categorical)?**

The response variable is number of days between a project's registration and certification date (SubmittalTime).  This is a discrete numerical value.

### Explanatory 

**What is the explanatory variable, and what type is it (numerical/categorical)?**

The explanatory variables are the owner types, rating system families, and platform versions.

### Relevant summary statistics 

**Provide summary statistics relevant to your research question. For example, if you’re comparing means across groups provide means, SDs, sample sizes of each group. This step requires the use of R, hence a code chunk is provided below. Insert more code chunks as needed.**

```{r}
require(ggplot2)

####Graphs based on present assumptions
table(completed_projects$OwnerTypesAdj)
table(completed_projects$RatingSystemFamily)
table(completed_projects$Platform)

#General Rating System Family histogram
ggplot(completed_projects, aes(x=SubmittalTime, fill=RatingSystemFamily))+geom_histogram(binwidth = 100, alpha=0.5, position = "identity", aes(y=..density..))
#General Platform histogram
ggplot(completed_projects, aes(x=SubmittalTime, fill=Platform))+geom_histogram(binwidth = 100, alpha=0.5, position = "identity", aes(y=..density..))
#General Platform ~ Rating System Family boxplot
ggplot(completed_projects, aes(y=SubmittalTime, x=Platform))+geom_boxplot()+facet_wrap(~RatingSystemFamily)


#Graph by owner types
ggplot(completed_projects, aes(x=SubmittalTime))+geom_histogram(binwidth = 100, alpha=0.5, position = "identity", aes(y=..density..))+facet_wrap(~OwnerTypesAdj)
ggplot(completed_projects, aes(x=SubmittalTime, fill=RatingSystemFamily))+geom_histogram(binwidth = 100, alpha=0.5, position = "identity", aes(y=..density..))+facet_wrap(~OwnerTypesAdj)
ggplot(completed_projects, aes(y=SubmittalTime, x=RatingSystemFamily))+geom_boxplot()+facet_wrap(~OwnerTypesAdj)

####Rating System Family Tests
completed_projects_BDC <- subset(completed_projects, completed_projects$RatingSystemFamily=="BDC")
ggplot(completed_projects_BDC, aes(x=SubmittalTime, fill=Platform))+geom_histogram(binwidth = 50, alpha=0.5, position = "identity", aes(y=..density..))

completed_projects_IDC <- subset(completed_projects, completed_projects$RatingSystemFamily=="IDC")
ggplot(completed_projects_IDC, aes(x=SubmittalTime, fill=Platform))+geom_histogram(binwidth = 50, alpha=0.5, position = "identity", aes(y=..density..))

completed_projects_OM <- subset(completed_projects, completed_projects$RatingSystemFamily=="OM")
ggplot(completed_projects_OM, aes(x=SubmittalTime, fill=Platform))+geom_histogram(binwidth = 50, alpha=0.5, position = "identity", aes(y=..density..))

#Test to see if project timelines decrease as the time between the registration date and the launch date increases
#Create a data frame of completed v2 projects that are at least as old as the v3 launch.  This is so that we know we aren't creating a bias with recently registered projects that certified quickly.
completed_projects_v2 <- subset(completed_projects, completed_projects$Platform=="v2" & completed_projects$RegistrationDate < (latest_date - maxv3days))
table(completed_projects_v2$RegYear)
completed_projects_v2 <- subset(completed_projects_v2, completed_projects_v2$RegYear < 5)
ggplot(completed_projects_v2, aes(y=SubmittalTime, x=RatingSystemFamily))+geom_boxplot()+facet_wrap(~RegYear)

#test for likelyhood of certification
BDC_sub <- subset(project_data_reduc, project_data_reduc$RatingSystemFamily=="BDC")
IDC_sub <- subset(project_data_reduc, project_data_reduc$RatingSystemFamily=="IDC")
OM_sub <- subset(project_data_reduc, project_data_reduc$RatingSystemFamily=="OM")
maxv3years <- max(trunc(project_data_reduc$SubmittalTime / 365) + 1, na.rm = TRUE)
v2_years <- rep(NA,maxv3years)
v2_years_c <- rep(NA,maxv3years)
v2_BDC_years <- rep(NA,maxv3years)
v2_BDC_years_c <- rep(NA,maxv3years)
v2_IDC_years <- rep(NA,maxv3years)
v2_IDC_years_c <- rep(NA,maxv3years)
v2_OM_years <- rep(NA,maxv3years)
v2_OM_years_c <- rep(NA,maxv3years)
v3_years <- rep(NA,maxv3years)
v3_years_c <- rep(NA,maxv3years)
v3_BDC_years <- rep(NA,maxv3years)
v3_BDC_years_c <- rep(NA,maxv3years)
v3_IDC_years <- rep(NA,maxv3years)
v3_IDC_years_c <- rep(NA,maxv3years)
v3_OM_years <- rep(NA,maxv3years)
v3_OM_years_c <- rep(NA,maxv3years)
n <- maxv3years
for(i in 1:maxv3years){
  v2_years[i] <- nrow(subset(project_data_reduc, project_data_reduc$Platform=="v2" & trunc(project_data_reduc$SubmittalTime / 365 + 1) == i)) / nrow(subset(project_data_reduc, project_data_reduc$Platform=="v2"))
  v2_years_c[i] <- nrow(subset(project_data_reduc, project_data_reduc$Platform=="v2" & trunc(project_data_reduc$SubmittalTime / 365 + 1) <= i)) / nrow(subset(project_data_reduc, project_data_reduc$Platform=="v2"))
  v2_BDC_years[i] <- nrow(subset(BDC_sub, BDC_sub$Platform=="v2" & trunc(BDC_sub$SubmittalTime / 365 + 1) == i)) / nrow(subset(BDC_sub, BDC_sub$Platform=="v2"))
  v2_BDC_years_c[i] <- nrow(subset(BDC_sub, BDC_sub$Platform=="v2" & trunc(BDC_sub$SubmittalTime / 365 + 1) <= i)) / nrow(subset(BDC_sub, BDC_sub$Platform=="v2"))
  v2_IDC_years[i] <- nrow(subset(IDC_sub, IDC_sub$Platform=="v2" & trunc(IDC_sub$SubmittalTime / 365 + 1) == i)) / nrow(subset(IDC_sub, IDC_sub$Platform=="v2"))
  v2_IDC_years_c[i] <- nrow(subset(IDC_sub, IDC_sub$Platform=="v2" & trunc(IDC_sub$SubmittalTime / 365 + 1) <= i)) / nrow(subset(IDC_sub, IDC_sub$Platform=="v2"))
  v2_OM_years[i] <- nrow(subset(OM_sub, OM_sub$Platform=="v2" & trunc(OM_sub$SubmittalTime / 365 + 1) == i)) / nrow(subset(OM_sub, OM_sub$Platform=="v2"))
  v2_OM_years_c[i] <- nrow(subset(OM_sub, OM_sub$Platform=="v2" & trunc(OM_sub$SubmittalTime / 365 + 1) <= i)) / nrow(subset(OM_sub, OM_sub$Platform=="v2"))
  v3_years[i] <- nrow(subset(project_data_reduc, project_data_reduc$Platform=="v3" & trunc(project_data_reduc$SubmittalTime / 365 + 1) == i )) / nrow(subset(project_data_reduc, project_data_reduc$Platform=="v3"))
  v3_years_c[i] <- nrow(subset(project_data_reduc, project_data_reduc$Platform=="v3" & trunc(project_data_reduc$SubmittalTime / 365 + 1) <= i )) / nrow(subset(project_data_reduc, project_data_reduc$Platform=="v3"))
  v3_BDC_years[i] <- nrow(subset(BDC_sub, BDC_sub$Platform=="v3" & trunc(BDC_sub$SubmittalTime / 365 + 1) == i)) / nrow(subset(BDC_sub, BDC_sub$Platform=="v3"))
  v3_BDC_years_c[i] <- nrow(subset(BDC_sub, BDC_sub$Platform=="v3" & trunc(BDC_sub$SubmittalTime / 365 + 1) <= i)) / nrow(subset(BDC_sub, BDC_sub$Platform=="v3"))
  v3_IDC_years[i] <- nrow(subset(IDC_sub, IDC_sub$Platform=="v3" & trunc(IDC_sub$SubmittalTime / 365 + 1) == i)) / nrow(subset(IDC_sub, IDC_sub$Platform=="v3"))
  v3_IDC_years_c[i] <- nrow(subset(IDC_sub, IDC_sub$Platform=="v3" & trunc(IDC_sub$SubmittalTime / 365 + 1) <= i)) / nrow(subset(IDC_sub, IDC_sub$Platform=="v3"))
  v3_OM_years[i] <- nrow(subset(OM_sub, OM_sub$Platform=="v3" & trunc(OM_sub$SubmittalTime / 365 + 1) == i)) / nrow(subset(OM_sub, OM_sub$Platform=="v3"))
  v3_OM_years_c[i] <- nrow(subset(OM_sub, OM_sub$Platform=="v3" & trunc(OM_sub$SubmittalTime / 365 + 1) <= i)) / nrow(subset(OM_sub, OM_sub$Platform=="v3"))
}
certification_ratio_df <- data.frame(c(1:maxv3years))
names(certification_ratio_df) <- c("years")
certification_ratio_df$v2 <- v2_years
certification_ratio_df$v3 <- v3_years
certification_ratio_df$v2_BDC <- v2_BDC_years
certification_ratio_df$v2_IDC <- v2_IDC_years
certification_ratio_df$v2_OM <- v2_OM_years
certification_ratio_df$v3_BDC <- v3_BDC_years
certification_ratio_df$v3_IDC <- v3_IDC_years
certification_ratio_df$v3_OM <- v3_OM_years

certification_ratio_df_c <- data.frame(c(1:maxv3years))
names(certification_ratio_df_c) <- c("years")
certification_ratio_df_c$v2 <- v2_years_c
certification_ratio_df_c$v3 <- v3_years_c
certification_ratio_df_c$v2_BDC <- v2_BDC_years_c
certification_ratio_df_c$v2_IDC <- v2_IDC_years_c
certification_ratio_df_c$v2_OM <- v2_OM_years_c
certification_ratio_df_c$v3_BDC <- v3_BDC_years_c
certification_ratio_df_c$v3_IDC <- v3_IDC_years_c
certification_ratio_df_c$v3_OM <- v3_OM_years_c

require(reshape2)
certification_ratio_df_reshape <- melt(certification_ratio_df[,1:9], id.vars = "years")
certification_ratio_df_reshape_c <- melt(certification_ratio_df_c[,1:9], id.vars = "years")
certification_ratio_df_reshape$Platform <- sapply(certification_ratio_df_reshape$variable, 
                                                     function(x){
                                                       x <- ifelse(grepl("v2",x),"v2","v3") 
                                                     }
)
certification_ratio_df_reshape_c$Platform <- sapply(certification_ratio_df_reshape_c$variable, 
                                                  function(x){
                                                    x <- ifelse(grepl("v2",x),"v2","v3") 
                                                  }
)
ggplot(certification_ratio_df_reshape, aes(y = value, x=years, fill=variable))+geom_bar(stat = "identity", position = "dodge")+facet_wrap(~Platform)+labs(y="Percent of Certified Projects By Year")
ggplot(certification_ratio_df_reshape_c, aes(y = value, x=years, fill=variable))+geom_bar(stat = "identity", position = "dodge")+facet_wrap(~Platform)+labs(y="Percent of Certified Projects Cumulatively")
```

I have prepared alternate calculations which instead take a project timeline length into account, and do not consider how long after the Rating System Launch the project was registered.  This increases the data set for v2 projects and would be okay as long as we can consider that the amoutn of time it takes to register a project does not decrease as the time between registration and launch increases.  There are graphs to check this at the end of this section

```{r}
project_data_reduc <- project_data
#If a v2 project is pending longer than the maximum amount of days v3 has been open, then change the length to that time
project_data_reduc$SubmittalTimePending <- ifelse(project_data$Platform=="v2" & project_data$SubmittalTimePending > maxv3days,maxv3days,project_data$SubmittalTimePending)
#If a v2 project submittal time was longer than the maximum amount of v3 days, then consider it an open project with the maximum v3 days of pending time.
project_data_reduc$SubmittalTimePending <- ifelse(project_data$Platform=="v2" & project_data$SubmittalTime > maxv3days,maxv3days,project_data$SubmittalTimePending)
#For the same issue noted above, make sure the SubmittalTime column registers an NA for theses projects
project_data_reduc$SubmittalTime <- ifelse(project_data$Platform=="v2" & project_data$SubmittalTime>maxv3days,NA,project_data$SubmittalTime)

#Make sure all columns have good data and that v4, ND, and Homes projects are excluded due to small size.
completed_projects <- subset(project_data_reduc, project_data_reduc$RegAfterLaunch>0 & project_data_reduc$SubmittalTime>0 & !(is.na(project_data_reduc$CertDate)) & !(identical(project_data_reduc$RatingSystemFamily, character(0))) & !(is.na(project_data_reduc$RatingSystemFamily)) & !(project_data_reduc$RatingSystemFamily=="ND") & !(project_data_reduc$RatingSystemFamily=="Homes") & !(project_data_reduc$Platform=="v4"))

#Same as above.
open_projects <- subset(project_data_reduc, project_data_reduc$RegAfterLaunch>0 & project_data_reduc$SubmittalTimePending>0 & is.na(project_data_reduc$CertDate) & !(identical(project_data_reduc$RatingSystemFamily,character(0))) & !(is.na(project_data_reduc$Platform)) & !(project_data_reduc$RatingSystemFamily=="ND") & !(project_data_reduc$RatingSystemFamily=="Homes") & !(project_data_reduc$Platform=="v4"))

#Table summaries
table(completed_projects$OwnerTypesAdj)
table(completed_projects$RatingSystemFamily)
table(completed_projects$Platform)

#General Rating System Family histogram
ggplot(completed_projects, aes(x=SubmittalTime, fill=RatingSystemFamily))+geom_histogram(binwidth = 100, alpha=0.5, position = "identity", aes(y=..density..))
#General Platform histogram
ggplot(completed_projects, aes(x=SubmittalTime, fill=Platform))+geom_histogram(binwidth = 100, alpha=0.5, position = "identity", aes(y=..density..))
#General Platform ~ Rating System Family boxplot
ggplot(completed_projects, aes(y=SubmittalTime, x=Platform))+geom_boxplot()+facet_wrap(~RatingSystemFamily)


#Graph by owner types
ggplot(completed_projects, aes(x=SubmittalTime))+geom_histogram(binwidth = 100, alpha=0.5, position = "identity", aes(y=..density..))+facet_wrap(~OwnerTypesAdj)
ggplot(completed_projects, aes(x=SubmittalTime, fill=RatingSystemFamily))+geom_histogram(binwidth = 100, alpha=0.5, position = "identity", aes(y=..density..))+facet_wrap(~OwnerTypesAdj)
ggplot(completed_projects, aes(y=SubmittalTime, x=RatingSystemFamily))+geom_boxplot()+facet_wrap(~OwnerTypesAdj)

####Rating System Family Tests
completed_projects_BDC <- subset(completed_projects, completed_projects$RatingSystemFamily=="BDC")
ggplot(completed_projects_BDC, aes(x=SubmittalTime, fill=Platform))+geom_histogram(binwidth = 50, alpha=0.5, position = "identity", aes(y=..density..))

completed_projects_IDC <- subset(completed_projects, completed_projects$RatingSystemFamily=="IDC")
ggplot(completed_projects_IDC, aes(x=SubmittalTime, fill=Platform))+geom_histogram(binwidth = 50, alpha=0.5, position = "identity", aes(y=..density..))

completed_projects_OM <- subset(completed_projects, completed_projects$RatingSystemFamily=="OM")
ggplot(completed_projects_OM, aes(x=SubmittalTime, fill=Platform))+geom_histogram(binwidth = 50, alpha=0.5, position = "identity", aes(y=..density..))

#Test to see if project timelines decrease as the time between the registration date and the launch date increases
#Create a data frame of completed v2 projects that are at least as old as the v3 launch.  This is so that we know we aren't creating a bias with recently registered projects that certified quickly.
completed_projects_v2 <- subset(completed_projects, completed_projects$Platform=="v2" & completed_projects$RegistrationDate < (latest_date - maxv3days))
table(completed_projects_v2$RegYear)
completed_projects_v2 <- subset(completed_projects_v2, completed_projects_v2$RegYear < 5)
ggplot(completed_projects_v2, aes(y=SubmittalTime, x=RatingSystemFamily))+geom_boxplot()+facet_wrap(~RegYear)

#test for likelyhood of certification
BDC_sub <- subset(project_data_reduc, project_data_reduc$RatingSystemFamily=="BDC")
IDC_sub <- subset(project_data_reduc, project_data_reduc$RatingSystemFamily=="IDC")
OM_sub <- subset(project_data_reduc, project_data_reduc$RatingSystemFamily=="OM")
maxv3years <- max(trunc(project_data_reduc$SubmittalTime / 365) + 1, na.rm = TRUE)
v2_years <- rep(NA,maxv3years)
v2_years_c <- rep(NA,maxv3years)
v2_BDC_years <- rep(NA,maxv3years)
v2_BDC_years_c <- rep(NA,maxv3years)
v2_IDC_years <- rep(NA,maxv3years)
v2_IDC_years_c <- rep(NA,maxv3years)
v2_OM_years <- rep(NA,maxv3years)
v2_OM_years_c <- rep(NA,maxv3years)
v3_years <- rep(NA,maxv3years)
v3_years_c <- rep(NA,maxv3years)
v3_BDC_years <- rep(NA,maxv3years)
v3_BDC_years_c <- rep(NA,maxv3years)
v3_IDC_years <- rep(NA,maxv3years)
v3_IDC_years_c <- rep(NA,maxv3years)
v3_OM_years <- rep(NA,maxv3years)
v3_OM_years_c <- rep(NA,maxv3years)
n <- maxv3years
for(i in 1:maxv3years){
  v2_years[i] <- nrow(subset(project_data_reduc, project_data_reduc$Platform=="v2" & trunc(project_data_reduc$SubmittalTime / 365 + 1) == i)) / nrow(subset(project_data_reduc, project_data_reduc$Platform=="v2"))
  v2_years_c[i] <- nrow(subset(project_data_reduc, project_data_reduc$Platform=="v2" & trunc(project_data_reduc$SubmittalTime / 365 + 1) <= i)) / nrow(subset(project_data_reduc, project_data_reduc$Platform=="v2"))
  v2_BDC_years[i] <- nrow(subset(BDC_sub, BDC_sub$Platform=="v2" & trunc(BDC_sub$SubmittalTime / 365 + 1) == i)) / nrow(subset(BDC_sub, BDC_sub$Platform=="v2"))
  v2_BDC_years_c[i] <- nrow(subset(BDC_sub, BDC_sub$Platform=="v2" & trunc(BDC_sub$SubmittalTime / 365 + 1) <= i)) / nrow(subset(BDC_sub, BDC_sub$Platform=="v2"))
  v2_IDC_years[i] <- nrow(subset(IDC_sub, IDC_sub$Platform=="v2" & trunc(IDC_sub$SubmittalTime / 365 + 1) == i)) / nrow(subset(IDC_sub, IDC_sub$Platform=="v2"))
  v2_IDC_years_c[i] <- nrow(subset(IDC_sub, IDC_sub$Platform=="v2" & trunc(IDC_sub$SubmittalTime / 365 + 1) <= i)) / nrow(subset(IDC_sub, IDC_sub$Platform=="v2"))
  v2_OM_years[i] <- nrow(subset(OM_sub, OM_sub$Platform=="v2" & trunc(OM_sub$SubmittalTime / 365 + 1) == i)) / nrow(subset(OM_sub, OM_sub$Platform=="v2"))
  v2_OM_years_c[i] <- nrow(subset(OM_sub, OM_sub$Platform=="v2" & trunc(OM_sub$SubmittalTime / 365 + 1) <= i)) / nrow(subset(OM_sub, OM_sub$Platform=="v2"))
  v3_years[i] <- nrow(subset(project_data_reduc, project_data_reduc$Platform=="v3" & trunc(project_data_reduc$SubmittalTime / 365 + 1) == i )) / nrow(subset(project_data_reduc, project_data_reduc$Platform=="v3"))
  v3_years_c[i] <- nrow(subset(project_data_reduc, project_data_reduc$Platform=="v3" & trunc(project_data_reduc$SubmittalTime / 365 + 1) <= i )) / nrow(subset(project_data_reduc, project_data_reduc$Platform=="v3"))
  v3_BDC_years[i] <- nrow(subset(BDC_sub, BDC_sub$Platform=="v3" & trunc(BDC_sub$SubmittalTime / 365 + 1) == i)) / nrow(subset(BDC_sub, BDC_sub$Platform=="v3"))
  v3_BDC_years_c[i] <- nrow(subset(BDC_sub, BDC_sub$Platform=="v3" & trunc(BDC_sub$SubmittalTime / 365 + 1) <= i)) / nrow(subset(BDC_sub, BDC_sub$Platform=="v3"))
  v3_IDC_years[i] <- nrow(subset(IDC_sub, IDC_sub$Platform=="v3" & trunc(IDC_sub$SubmittalTime / 365 + 1) == i)) / nrow(subset(IDC_sub, IDC_sub$Platform=="v3"))
  v3_IDC_years_c[i] <- nrow(subset(IDC_sub, IDC_sub$Platform=="v3" & trunc(IDC_sub$SubmittalTime / 365 + 1) <= i)) / nrow(subset(IDC_sub, IDC_sub$Platform=="v3"))
  v3_OM_years[i] <- nrow(subset(OM_sub, OM_sub$Platform=="v3" & trunc(OM_sub$SubmittalTime / 365 + 1) == i)) / nrow(subset(OM_sub, OM_sub$Platform=="v3"))
  v3_OM_years_c[i] <- nrow(subset(OM_sub, OM_sub$Platform=="v3" & trunc(OM_sub$SubmittalTime / 365 + 1) <= i)) / nrow(subset(OM_sub, OM_sub$Platform=="v3"))
}
certification_ratio_df <- data.frame(c(1:maxv3years))
names(certification_ratio_df) <- c("years")
certification_ratio_df$v2 <- v2_years
certification_ratio_df$v3 <- v3_years
certification_ratio_df$v2_BDC <- v2_BDC_years
certification_ratio_df$v2_IDC <- v2_IDC_years
certification_ratio_df$v2_OM <- v2_OM_years
certification_ratio_df$v3_BDC <- v3_BDC_years
certification_ratio_df$v3_IDC <- v3_IDC_years
certification_ratio_df$v3_OM <- v3_OM_years

certification_ratio_df_c <- data.frame(c(1:maxv3years))
names(certification_ratio_df_c) <- c("years")
certification_ratio_df_c$v2 <- v2_years_c
certification_ratio_df_c$v3 <- v3_years_c
certification_ratio_df_c$v2_BDC <- v2_BDC_years_c
certification_ratio_df_c$v2_IDC <- v2_IDC_years_c
certification_ratio_df_c$v2_OM <- v2_OM_years_c
certification_ratio_df_c$v3_BDC <- v3_BDC_years_c
certification_ratio_df_c$v3_IDC <- v3_IDC_years_c
certification_ratio_df_c$v3_OM <- v3_OM_years_c

require(reshape2)
certification_ratio_df_reshape <- melt(certification_ratio_df[,1:9], id.vars = "years")
certification_ratio_df_reshape_c <- melt(certification_ratio_df_c[,1:9], id.vars = "years")
certification_ratio_df_reshape$Platform <- sapply(certification_ratio_df_reshape$variable, 
                                                     function(x){
                                                       x <- ifelse(grepl("v2",x),"v2","v3") 
                                                     }
)
certification_ratio_df_reshape_c$Platform <- sapply(certification_ratio_df_reshape_c$variable, 
                                                  function(x){
                                                    x <- ifelse(grepl("v2",x),"v2","v3") 
                                                  }
)
ggplot(certification_ratio_df_reshape, aes(y = value, x=years, fill=variable))+geom_bar(stat = "identity", position = "dodge")+facet_wrap(~Platform)+labs(y="Percent of Certified Projects By Year")
ggplot(certification_ratio_df_reshape_c, aes(y = value, x=years, fill=variable))+geom_bar(stat = "identity", position = "dodge")+facet_wrap(~Platform)+labs(y="Percent of Certified Projects Cumulatively")
```

